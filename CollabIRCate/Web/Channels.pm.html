<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title></title>
<link rel="stylesheet" type="text/css" href="../../podstyle.css" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <script type="text/javascript">

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;

    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  </script></head>
<body>
<div class="box">
  <h1 class="t1">CollabIRCate</h1>
  <table>
    <tr>
      <td class="label">Description</td>
      <td class="cell">CollabIRCate is a free, open-source collaboration tool</td>
    </tr>
  </table>
</div>
<div class="path">
  <a href="../../index.html">CollabIRCate</a> &gt; Perl Modules &gt;
  CollabIRCate-Web-Channels
</div>
<div>
<a href="../../src/CollabIRCate/Web/Channels.pm">Source</a>
</div>


<div class="pod">
<!-- INDEX START -->
<h3 id="TOP">Index</h3>
<ul>
	<li><a href="#list">list</a></li>
	<li><a href="#show">show</a></li>
</ul>
</li>
</ul>
<hr />
<!-- INDEX END -->

<h2 id="list">list</h2>

<p><a href="#" onclick="toggleCode('method_list');return false;">[Source]</a></p>
                                        <div class="method-source-code" id="method_list">
                                        <pre>

sub list {
    my $self = shift;

    my $channels = CollabIRCate::DB::Channel::Manager->get_channels();

    $self->stash->{channels} = $channels;
}
</pre></div>

<p>List all the channels.</p>

<h2 id="show">show</h2>

<p><a href="#" onclick="toggleCode('method_show');return false;">[Source]</a></p>
                                        <div class="method-source-code" id="method_show">
                                        <pre>

sub show {
    my $self    = shift;
    my $channel = $self->stash->{'channel'};
    my $page    = $self->stash->{'page'};
    my $date    = $self->stash->{'date'};
    my $pager   = Data::Page->new();

    $pager->current_page($page);

    # XXX this is an ugly hack and has to go
    $channel = '#' . $channel;

    my $channel_db;
    eval {
        $channel_db
            = CollabIRCate::DB::Channel->new( name => $channel )->load;
    };

    if ($@) {
        $logger->error("failed to load channel $channel - $@");
        $self->stash->{message} = 'bad channel';
        $self->stash->{logs}    = [];
        return;
    }

    # load the logs for this day
    my $now;
    if ($date eq 'today') {
        $now = DateTime->now();
    }
    else {
        my ($year, $month, $day) = ($date =~ /^(\d\d\d\d)\-(\d\d)\-(\d\d)$/);
        croak "bad date $date" if (! $day);
        $now = DateTime->new(year => $year, month => $month, day => $day);
    }
    
    my $dt_begin = $now->truncate( to => 'day' );
    my $dt_end   = $dt_begin->clone->add( days => 1 );

    my $yesterday = $dt_begin->clone->subtract ( days => 1);
    
    my $query = [
        channel_id => $channel_db->id,
        ts         => { 'gt' => $dt_begin },
        ts         => { 'lt' => $dt_end }
    ];

    $pager->total_entries(
        CollabIRCate::DB::Log::Manager->get_logs_count( query => $query ) );
    $pager->entries_per_page(100);

    my $logs = CollabIRCate::DB::Log::Manager->get_logs(
        query   => $query,
        sort_by => 'ts',
        offset => $pager->skipped,
        limit  => $pager->entries_per_page,
    );

    $self->stash->{logs}    = $logs;
    $self->stash->{message} = 'hi';
    $self->stash->{pager}   = $pager;
    $self->stash->{tomorrow} = $dt_end->ymd;
    $self->stash->{yesterday} = $yesterday->ymd;
}
</pre></div>

<p>Show the log of a channel.</p>


</div><div class="footer">generated by <a href="http://search.cpan.org/perldoc?Pod%3A%3AProjectDocs">Pod::ProjectDocs</a></div></body>
</html>
